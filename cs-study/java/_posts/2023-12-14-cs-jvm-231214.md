---
layout: post
title: "JVM (Java Virtual Machine)"
date: 2023-12-14 15:42:20 +0900
description: 'CS: JVM'
img: # Add image post (optional)
fig-caption: # Add figcaption (optional)
tags: [JVM, java]
categories: [study, cs]
---

# JVM

- Java Virtual Machine. 자바 가상 머신
- 자바 프로그램을 실행하기 위한 환경을 제공
- 자바 바이트 코드를 실행하고, 메모리 관리 및 다양한 기능 담당
- 플랫폼 독립성 제공
- 자바 언어로 작성된 프로그램이 어떤 환경에서도 동일한 방식으로 실행될 수 있도록 함
- 스택 기반으로 동작
  - 코드 작성, 컴파일 쉬움
  - 다양한 하드웨어에서 사용 가능
    - 하드웨어 (레지스터, CPU 등)에 대해 직접 다루지 않음
  - 피연산자가 스택 포인터에 의해 암시적으로 처리됨

## 구조

![Untitled](/assets/img/posts/cs-study/java/jvm/Untitled%202.png)

- 자바 인터프리터(interpreter)
  - 자바 컴파일러에 의해 변환된 바이트 코드를 읽고 한 줄씩 기계어로 해석하는 역할
  - 원래는 인터프리터 방식만 사용하다가 성능 이슈로 인해 JIT 컴파일러 추가
  - 현재는 컴파일과 인터프리터 방식 병행해서 사용
- 클래스 로더(class loader)
  - 자바는 동적으로 클래스를 읽어오기 때문에 프로그램이 실행중인 런타임에서 JVM과 연결됨
  - 한 번에 메모리에 모든 클래스를 로드하는 것이 아닌, 필요한 순간에 해당 클래스(.class) 파일을 찾아 메모리에 로딩해줌
- JIT 컴파일러(Just-In Time compiler)
  - 프로그램이 실행 중인 런타임 중에 여러번 호출되는 메소드들을 미리 만들어 둔 해석본을 이용해서 컴파일하는 역할
  - 인터프리터 방식의 단점을 보완하기 위해 도입
  - 실행 시점에 인터프리터 방식으로 기계어를 생성할때 자주 사용되는 메소드의 경우 컴파일하고 기계어를 캐싱
  - 해당 메소드를 여러 번 호출할 때 매번 해석하는 것 방지
  <details>
    <summary>컴파일 임계치(Compile Threshold)</summary>
    <ul>
      <li>JIT 컴파일러가 메소드가 자주 사용되는지 체크하는 방식으로 컴파일 임계치를 사용</li>
      <li>컴파일 임계치가 초과하면 JIT 컴파일이 트리거되어서 기계어를 캐싱</li>
      <li>method entry counter (JVM 내에 있는 메서드가 호출된 횟수)</li>
      <li>back-edge loop counter (메서드가 종료된 횟수)에 기반하여 판단</li>
    </ul>
  </details>

- 가비지 컬렉터(garbage collector)

## 실행 과정

1. 프로그램이 실행되면 JVM은 OS로부터 이 프로그램이 필요로 하는 메모리 할당받음
  - JVM이 이 메모리를 용도에 따라 여러 영역으로 나누어 관리함
2. **컴파일러(Compiler):**
  - Java 소스 코드(.java 파일)는 Java 컴파일러에 의해 바이트 코드(.class 파일)로 컴파일됨
  - 바이트 코드는 중간 언어로, 특정 플랫폼이나 운영체제에 종속되지 않음
3. **클래스 로더(Class Loader):**
  - 컴파일된 바이트 코드는 클래스 로더에 의해 메모리로 로딩
  - 클래스 로더는 클래스 파일을 찾아서 읽어들이고, 필요할 때 동적으로 로딩
4. **바이트 코드 검증(Bytecode Verification):**
  - 로딩된 바이트 코드는 JVM에 의해 검증
  - 이 과정에서 코드의 유효성과 안전성이 확인되며, 잘못된 코드가 있으면 예외가 발생하고 프로그램 실행이 중단
5. **실행 엔진(Execution Engine):**
  - 검증된 바이트 코드는 실행 엔진에 의해 해석되거나, 더 나아가 JIT(Just-In-Time) 컴파일러에 의해 기계어로 변환
  - 해석 방식의 실행은 바이트 코드를 직접 실행하는 방식
  - JIT 컴파일러는 바이트 코드를 네이티브 코드로 변환하여 캐시에 저장하고 재사용
6. **런타임(Runtime):**
  - 실행 엔진이 변환한 코드는 런타임 시에 실행
  - 프로그램이 동작하면서 객체의 생성, 메모리 할당, 스레드 관리 등의 작업이 수행
7. **가비지 컬렉션(Garbage Collection):**
  - JVM은 더 이상 사용되지 않는 객체를 자동으로 감지하고 제거하는 가비지 컬렉션을 수행

## 역할

- 자바 바이트 코드 실행
  - 자바 소스 코드는 자바 컴파일러를 통해 자바 바이트 코드로 변환
  - 이때 JVM이 해당 바이트 코드를 실행하여 기계어로 변환하고 실행환경에 맞게 해석
- 메모리 관리
  - 메모리를 관리하고 가비지 컬렉션(Garbage Collection)을 수행하여 더 이상 참조되지 않는 객체들 정리
  - 메모리 누수 방지
  - 프로그램 성능 최적화
- 스레드 관리
  - 다중 스레드를 지원
  - 스레드 스케줄링 및 동기화를 관리하여 자바 프로그램에서 동시성을 구현
- 클래스 로딩
  - 자바 애플리케이션이 실행될 때, 필요한 클래스들을 동적으로 로딩하고 링크
  - 필요한 클래스를 메모리에 적재하여 사용
- 실행 예외 처리
  - 자바 프로그램에서 발생하는 예외를 처리
  - 예외 정보를 출력하거나 적절한 예외 처리 루틴을 실행
- 자원 관리
  - 파일, 네트워크 연결, 데이터베이스 연결과 같은 시스템 자원을 관리
  - 프로그램이 안전하게 자원을 사용하도록 지원
- JIT 컴파일러
  - Just-In-Time 컴파일러
  - 바이트 코드를 실행 직전에 네이티브 기계어로 변환하여 성능을 향상
- 시스템 라이브러리 지원
  - 자바 프로그램이 시스템 라이브러리를 사용할 수 있도록 지원
  - 네이티브 인터페이스를 통해 다른 언어와 통합 가능

## 자바 바이트 코드 (**Java bytecode**)

- JVM이 이해할 수 있는 언어로 변환된 자바 소스코드
- 확장자 `.class`
- JVM만 설치되어 있으면 어떤 OS라도 각 OS에 맞는 실행 파일로 변환하여 실행할 수 있음
